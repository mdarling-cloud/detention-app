<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin Tools</title>
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#ffffff">
  <style>
    body { font-family: -apple-system, system-ui, Arial; margin: 0; background:#f6f6f6; }
    .page { max-width: 520px; margin: 0 auto; padding: 18px; }
    h1 { margin: 10px 0 2px; font-size: 28px; }
    p.sub { margin: 0 0 18px; color: #666; }
    .card { background: #fff; border-radius: 14px; padding: 14px; box-shadow: 0 1px 8px rgba(0,0,0,.06); margin-bottom: 14px; }
    button { width:100%; padding: 14px; border-radius: 12px; border: 0; font-size: 16px; }
    button.primary { background:#0a84ff; color:white; }
    button.secondary { background:#e9e9ea; }
    button:disabled { opacity:.6; }
    label { display:block; font-weight:600; margin: 12px 0 6px; }
    select, input, textarea {
      width:100%; padding: 12px; border-radius: 10px; border: 1px solid #ddd; background:white; font-size: 16px;
    }
    .row { display:flex; gap:10px; }
    .row > * { flex: 1; }
    .topbar { display:flex; gap:10px; align-items:center; margin-bottom: 8px; }
    .linkbtn { background:none; border:0; color:#0a84ff; font-size:16px; padding: 0; }
    .muted { color:#666; font-size: 14px; }
    .error { color:#b00020; font-weight:600; }
    .success { color:#0a7a2f; font-weight:600; }
  </style>
</head>
<body>
  <div class="page">

    <!-- HOME -->
    <div id="homeView" class="card">
      <h1>Admin Tools</h1>
      <p class="sub">Detentions & student info</p>
      <button class="secondary" disabled>Look Up Student (Coming Soon)</button>
      <div style="height:10px"></div>
      <button class="primary" id="goAssign">Assign Detention</button>
    </div>

    <!-- ASSIGN -->
    <div id="assignView" class="card" style="display:none">
      <div class="topbar">
        <button class="linkbtn" id="backHome">← Home</button>
        <div style="flex:1"></div>
      </div>
      <h2 style="margin:0 0 10px">Assign Detention</h2>

      <div id="loadMsg" class="muted">Loading options…</div>
      <div id="errMsg" class="error" style="display:none"></div>

      <div id="formArea" style="display:none">
        <label>Choose Student</label>
        <input id="studentSearch" placeholder="Search student (optional)" />
        <select id="studentSelect"></select>

        <label>Reason for Detention</label>
        <select id="reasonSelect"></select>
        <div id="otherReasonWrap" style="display:none">
          <input id="otherReason" placeholder="Type a reason not listed" />
        </div>

        <label>Day to Serve</label>
        <select id="daySelect"></select>

        <label>Person Assigning</label>
        <select id="assignerSelect"></select>

        <div style="height:14px"></div>
        <button class="secondary" id="reviewBtn">Review</button>

        <!-- REVIEW (safeguard) -->
        <div id="reviewArea" style="display:none; margin-top:14px">
          <div class="card" style="box-shadow:none; border:1px solid #eee">
            <div style="font-weight:700; margin-bottom:8px">Review</div>
            <div><b>Student:</b> <span id="revStudent"></span></div>
            <div><b>Reason:</b> <span id="revReason"></span></div>
            <div><b>Day:</b> <span id="revDay"></span></div>
            <div><b>Assigner:</b> <span id="revAssigner"></span></div>
          </div>

          <button class="primary" id="submitBtn">Submit</button>
          <div style="height:10px"></div>
          <button class="secondary" id="editBtn">Edit</button>

          <div id="resultMsg" style="margin-top:10px"></div>
        </div>
      </div>
    </div>

  </div>

<script>
  // ✅ PASTE YOUR APPS SCRIPT /exec URL HERE
  const BACKEND = "https://script.google.com/macros/s/AKfycbzwRZlwiEGNZC0PDqDvZjc45acKOBp379eMW0CMc7zBO8Q9dTGzOC8lxMUhdluYhosX/exec";

  const homeView = document.getElementById("homeView");
  const assignView = document.getElementById("assignView");
  const goAssign = document.getElementById("goAssign");
  const backHome = document.getElementById("backHome");

  const loadMsg = document.getElementById("loadMsg");
  const errMsg = document.getElementById("errMsg");
  const formArea = document.getElementById("formArea");

  const studentSearch = document.getElementById("studentSearch");
  const studentSelect = document.getElementById("studentSelect");
  const reasonSelect = document.getElementById("reasonSelect");
  const otherReasonWrap = document.getElementById("otherReasonWrap");
  const otherReason = document.getElementById("otherReason");
  const daySelect = document.getElementById("daySelect");
  const assignerSelect = document.getElementById("assignerSelect");

  const reviewBtn = document.getElementById("reviewBtn");
  const reviewArea = document.getElementById("reviewArea");
  const submitBtn = document.getElementById("submitBtn");
  const editBtn = document.getElementById("editBtn");
  const resultMsg = document.getElementById("resultMsg");

  const revStudent = document.getElementById("revStudent");
  const revReason = document.getElementById("revReason");
  const revDay = document.getElementById("revDay");
  const revAssigner = document.getElementById("revAssigner");

  let options = null; // {students,reasons,days,assigners}

  let submitLockedUntilEdit = false;

  function lockSubmitUntilEdit_() {
    submitLockedUntilEdit = true;
    submitBtn.disabled = true;
  }

  function unlockSubmitIfLocked_() {
    if (submitLockedUntilEdit) {
      submitLockedUntilEdit = false;
      submitBtn.disabled = false;
    }
  }


  function showHome() {
    assignView.style.display = "none";
    homeView.style.display = "block";
  }

  function showAssign() {
    homeView.style.display = "none";
    assignView.style.display = "block";
  }

  goAssign.addEventListener("click", async () => {
    showAssign();
    await loadOptions();
  });

  backHome.addEventListener("click", () => {
    showHome();
  });

  async function loadOptions() {
    loadMsg.style.display = "block";
    errMsg.style.display = "none";
    formArea.style.display = "none";
    reviewArea.style.display = "none";
    resultMsg.innerHTML = "";

    try {
      const url = `${BACKEND}?action=options`;
      const res = await fetch(url);
      const json = await res.json();
      if (!json.ok) throw new Error(json.error || "Failed loading options");

      options = json;

      // Populate selects
      populateSelect(studentSelect, options.students);
      populateSelect(reasonSelect, options.reasons);
      populateSelect(assignerSelect, options.assigners);

      // initialize filtered list and build day dropdown (supports filtering by week)
      options._filteredDays = options.days;
      refreshDayOptions_();


      // defaults
      toggleOtherReason();
      loadMsg.style.display = "none";
      formArea.style.display = "block";

    } catch (e) {
      loadMsg.style.display = "none";
      errMsg.textContent = e.message;
      errMsg.style.display = "block";
    }
  }

  function populateSelect(selectEl, items) {
    selectEl.innerHTML = "";
    (items || []).forEach(v => {
      const opt = document.createElement("option");

      if (typeof v === "string") {
        opt.value = v;
        opt.textContent = v;
      } else {
        // expects {value,label}
        opt.value = v.value;
        opt.textContent = v.label;
      }

      selectEl.appendChild(opt);
    });
  }


  function toggleOtherReason() {
    otherReasonWrap.style.display = (reasonSelect.value === "Other...") ? "block" : "none";
  }

  reasonSelect.addEventListener("change", toggleOtherReason);

  // Simple search filter for student dropdown
  studentSearch.addEventListener("input", () => {
    if (!options) return;
    const q = studentSearch.value.trim().toLowerCase();
    const filtered = q
      ? options.students.filter(s => (s.label || s.value || "").toLowerCase().includes(q))
      : options.students;

    const current = studentSelect.value;
    populateSelect(studentSelect, filtered);

    // try to keep current selection if still present
    if (filtered.some(s => (typeof s === "string" ? s : s.value) === current)) {
      studentSelect.value = current;
    }

  });

  reviewBtn.addEventListener("click", () => {
    // Validate minimal requirements
    const studentName = studentSelect.value;
    const reason = reasonSelect.value;
    const other = otherReason.value.trim();
    const dayIdx = parseInt(daySelect.value, 10);
    const assigner = assignerSelect.value;

    if (!studentName) return alert("Choose a student.");
    if (!assigner) return alert("Choose who is assigning.");
    if (!options || !options._filteredDays || !options._filteredDays[dayIdx]) return alert("Choose a day.");
    if (!reason) return alert("Choose a reason.");
    if (reason === "Other..." && !other) return alert("Type the other reason.");

    const finalReason = (reason === "Other...") ? other : reason;

    revStudent.textContent = studentName;
    revReason.textContent = finalReason;
    revDay.textContent = options._filteredDays[dayIdx].display;
    revAssigner.textContent = assigner;

    const weekCount = getWeekCountForSelectedStudent_();
    const duration = (weekCount >= 1) ? 40 : 20;

    let reviewNote = `<div class="muted">Duration: <b>${duration} Minutes</b></div>`;
    if (weekCount >= 1) {
      reviewNote += `<div class="muted">Note: This student already has ${weekCount} detention(s) assigned this week.</div>`;
    }

    resultMsg.innerHTML = reviewNote;
    reviewArea.style.display = "block";

    window.scrollTo({ top: document.body.scrollHeight, behavior: "smooth" });
  });

  editBtn.addEventListener("click", () => {
    reviewArea.style.display = "none";
    resultMsg.innerHTML = "";
    unlockSubmitIfLocked_();
  });

  function getUsedDayKeysForSelectedStudent_() {
    if (!options) return [];
    const name = studentSelect.value;
    return (options.weekUsedDayKeys && options.weekUsedDayKeys[name]) ? options.weekUsedDayKeys[name] : [];
  }

  function getWeekCountForSelectedStudent_() {
    if (!options) return 0;
    const name = studentSelect.value;
    return (options.weekCounts && options.weekCounts[name]) ? options.weekCounts[name] : 0;
  }

  function refreshDayOptions_() {
    if (!options) return;

    const usedKeys = getUsedDayKeysForSelectedStudent_();
    const prevIdx = parseInt(daySelect.value, 10);

    daySelect.innerHTML = "";

    // Filter: if student already has >=1 this week, remove used days
    const weekCount = getWeekCountForSelectedStudent_();
    const filtered = (weekCount >= 1)
      ? options.days.filter(d => !usedKeys.includes(`${d.gVal}||${d.hVal}`))
      : options.days;

    filtered.forEach((d, idx) => {
      const opt = document.createElement("option");
      // we store the index into "filtered" list; but we still need to access the object
      opt.value = String(idx);
      opt.textContent = d.display;
      daySelect.appendChild(opt);
    });

    // store filtered list for submit/review
    options._filteredDays = filtered;

    // keep selection if possible
    if (prevIdx >= 0 && prevIdx < filtered.length) {
      daySelect.value = String(prevIdx);
    } else {
      daySelect.value = "0";
    }
  }

  studentSelect.addEventListener("change", () => {
    refreshDayOptions_();
    unlockSubmitIfLocked_();
  });



  submitBtn.addEventListener("click", async () => {
    submitBtn.disabled = true;
    resultMsg.innerHTML = `<div class="muted">Submitting…</div>`;

    try {
      const studentName = studentSelect.value;
      const reason = reasonSelect.value;
      const other = otherReason.value.trim();
      const dayIdx = parseInt(daySelect.value, 10);
      const assigner = assignerSelect.value;

      

      const params = new URLSearchParams();
      params.append("action", "submit");
      params.append("studentName", studentName);
      params.append("reason", reason);
      params.append("otherReason", (reason === "Other...") ? other : "");
      params.append("assigner", assigner);
      // send day as JSON string
      params.append("day", JSON.stringify(options._filteredDays[dayIdx]));

      const res = await fetch(BACKEND, {
        method: "POST",
        body: params
      });


      const json = await res.json();
      if (!json.ok) throw new Error(json.error || "Submit failed");

      let msg = `<div class="success">Saved.</div>`;
      if (json.wroteRow) msg += `<div class="muted">Raw Detention Data row: ${json.wroteRow}</div>`;
      if (json.emailed) msg += `<div class="muted">Email sent.</div>`;
      if (json.warning) msg += `<div class="muted">${json.warning}</div>`;

      resultMsg.innerHTML = msg;
      lockSubmitUntilEdit_();
    } catch (e) {
      resultMsg.innerHTML = `<div class="error">${e.message}</div>`;
    } finally {
      if (!submitLockedUntilEdit) submitBtn.disabled = false;
    }
  });

  [studentSelect, reasonSelect, daySelect, assignerSelect].forEach(el => {
    el.addEventListener("change", unlockSubmitIfLocked_);
  });
  otherReason.addEventListener("input", unlockSubmitIfLocked_);
  studentSearch.addEventListener("input", unlockSubmitIfLocked_);

  

</script>
</body>
</html>
